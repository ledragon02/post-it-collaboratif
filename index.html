<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Post-it</title>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background: #2c3e50; margin: 0; overflow: hidden; }
        #viewport { width: 100vw; height: 100vh; position: relative; overflow: hidden; cursor: grab; }
        #plateau { 
            width: 10000px; height: 10000px; background-color: #dfe6e9;
            background-image: radial-gradient(#bdc3c7 1px, transparent 1px);
            background-size: 40px 40px; position: absolute; transform-origin: 0 0;
        }
        .postit { 
            width: 220px; min-height: 220px; position: absolute; padding: 20px; 
            box-shadow: 5px 5px 15px rgba(0,0,0,0.15); cursor: text; outline: none; 
            font-size: 16px; white-space: pre-wrap; word-break: break-all;
            display: flex; align-items: center; justify-content: center; text-align: center;
            box-sizing: border-box; z-index: 10; transition: opacity 0.3s;
        }

        /* MINI-MAP */
        #minimap {
            position: fixed; bottom: 20px; right: 20px; width: 200px; height: 200px;
            background: rgba(255,255,255,0.9); border: 2px solid #34495e;
            z-index: 3000; border-radius: 8px; overflow: hidden; pointer-events: none;
        }
        .minimap-dot { position: absolute; width: 5px; height: 5px; border-radius: 1px; }

        /* UI CONTROLS */
        #ui { position: fixed; top: 15px; left: 15px; z-index: 2000; display: flex; gap: 10px; }
        .search-bar { padding: 10px; border-radius: 6px; border: none; width: 150px; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
        .btn { padding: 10px 20px; cursor: pointer; background: #2ecc71; color: white; border: none; border-radius: 6px; font-weight: bold; }
        .btn-blue { background: #3498db; }
        .btn-zen { background: #9b59b6; }
        
        /* MODE ZEN (Cache les curseurs) */
        .zen-mode .curseur { display: none !important; }

        /* CURSEURS */
        .curseur {
            position: absolute; width: 15px; height: 15px; border-radius: 50% 50% 50% 0; 
            pointer-events: none; z-index: 1000; border: 2px solid white; transform: rotate(-45deg);
        }
        .curseur-label { position: absolute; left: 18px; top: 18px; background: inherit; color: white; padding: 2px 6px; border-radius: 4px; font-size: 10px; transform: rotate(45deg); white-space: nowrap; }

        /* MENU CONTEXTUEL */
        #menu-context {
            position: fixed; display: none; background: white; border-radius: 8px; 
            z-index: 4000; box-shadow: 0 10px 25px rgba(0,0,0,0.3); padding: 12px; width: 160px;
        }
        .color-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; margin-bottom: 10px; }
        .pastille { width: 30px; height: 30px; cursor: pointer; border-radius: 4px; border: 1px solid #ddd; }
        .btn-delete { width: 100%; padding: 8px; background: #e74c3c; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; }
        
        #infos { position: fixed; top: 15px; right: 15px; background: white; padding: 10px; border-radius: 6px; z-index: 2000; border: 1px solid #ccc; font-size: 12px; }
    </style>
</head>
<body>

    <div id="ui">
        <button class="btn" onclick="creerNote()">+ Note</button>
        <button class="btn btn-blue" onclick="resetVue()">Recentrer</button>
        <button class="btn btn-zen" onclick="toggleZen()">Cach√© curseurs</button>
        <input type="text" class="search-bar" placeholder="Chercher..." oninput="rechercher(this.value)">
    </div>

    <div id="infos">ID: <b id="my-id">..</b> | Zoom: <b id="zoom-val">100%</b></div>
    <div id="minimap"></div>

    <div id="menu-context">
        <div class="color-grid" id="palette"></div>
        <button class="btn-delete" onclick="supprimerNoteCible()">SUPPRIMER</button>
    </div>

    <div id="viewport"><div id="plateau"></div></div>

    <script>
        const userId = Math.floor(Math.random() * 90 + 10);
        document.getElementById('my-id').innerText = userId;
        const socket = new WebSocket('ws://localhost:3000');
        const plateau = document.getElementById('plateau');
        const minimap = document.getElementById('minimap');
        const menu = document.getElementById('menu-context');
        
        let zoom = 1, panX = -4500, panY = -4500, isPanning = false, noteCibleId = null;

        const couleurs = ['#ffeaa7', '#fab1a0', '#81ecec', '#55efc4', '#a29bfe', '#fd79a8', '#74b9ff', '#ffffff', '#dfe6e9', '#ffe2e2', '#e2f0cb', '#badc58'];

        // Initialisation Palette
        const grid = document.getElementById('palette');
        couleurs.forEach(c => {
            const p = document.createElement('div');
            p.className = 'pastille'; p.style.background = c;
            p.onclick = () => { const el = document.getElementById(noteCibleId); if(el){el.style.background = c; sauver(el);} menu.style.display = 'none'; };
            grid.appendChild(p);
        });

        function refresh() { 
            plateau.style.transform = `translate(${panX}px, ${panY}px) scale(${zoom})`; 
            document.getElementById('zoom-val').innerText = Math.round(zoom * 100) + "%";
            updateMinimap();
        }
        function resetVue() { zoom = 1; panX = (window.innerWidth/2)-5000; panY = (window.innerHeight/2)-5000; refresh(); }
        refresh();

        function toggleZen() { document.body.classList.toggle('zen-mode'); }

        function updateMinimap() {
            minimap.innerHTML = '';
            document.querySelectorAll('.postit').forEach(n => {
                const dot = document.createElement('div');
                dot.className = 'minimap-dot';
                dot.style.left = (parseFloat(n.style.left) / 50) + 'px';
                dot.style.top = (parseFloat(n.style.top) / 50) + 'px';
                dot.style.background = n.style.background;
                minimap.appendChild(dot);
            });
        }

        function sauver(el) {
            if (socket.readyState === 1) {
                socket.send(JSON.stringify({
                    type: 'MAJ', idPostIt: el.id, auteur: userId,
                    posX: parseFloat(el.style.left), posY: parseFloat(el.style.top),
                    texte: el.innerText, couleur: el.style.background
                }));
            }
            updateMinimap();
        }

        // --- NAVIGATION & ZOOM ---
        window.addEventListener('wheel', (e) => {
            e.preventDefault();
            const delta = e.deltaY > 0 ? 0.9 : 1.1;
            const nextZoom = zoom * delta;
            if (nextZoom > 0.1 && nextZoom < 4) {
                panX = e.clientX - (e.clientX - panX) * delta;
                panY = e.clientY - (e.clientY - panY) * delta;
                zoom = nextZoom; refresh();
            }
        }, { passive: false });

        window.addEventListener('mousedown', (e) => {
            if (!menu.contains(e.target)) menu.style.display = 'none';
            if (e.button === 0 && (e.target.id === 'plateau' || e.target.id === 'viewport')) isPanning = true;
        });

        window.addEventListener('mousemove', (e) => {
            if (isPanning) { panX += e.movementX; panY += e.movementY; refresh(); }
            const wx = (e.clientX - panX) / zoom;
            const wy = (e.clientY - panY) / zoom;
            if (socket.readyState === 1) socket.send(JSON.stringify({ type: 'CURSEUR', auteur: userId, x: wx, y: wy }));
        });

        window.addEventListener('mouseup', () => isPanning = false);

        // --- DRAG NOTES ---
        document.addEventListener('mousedown', (e) => {
            if (e.target.classList.contains('postit') && e.button === 0) {
                const el = e.target;
                const startX = e.clientX, startY = e.clientY;
                const initL = parseFloat(el.style.left), initT = parseFloat(el.style.top);
                const move = (m) => {
                    el.style.left = (initL + (m.clientX - startX) / zoom) + 'px';
                    el.style.top = (initT + (m.clientY - startY) / zoom) + 'px';
                    sauver(el);
                };
                const up = () => { window.removeEventListener('mousemove', move); window.removeEventListener('mouseup', up); };
                window.addEventListener('mousemove', move); window.addEventListener('mouseup', up);
            }
        });

        window.addEventListener('contextmenu', (e) => {
            if (e.target.classList.contains('postit')) {
                e.preventDefault(); noteCibleId = e.target.id;
                menu.style.display = 'block'; menu.style.top = e.clientY + 'px'; menu.style.left = e.clientX + 'px';
            }
        });

        function supprimerNoteCible() {
            if (noteCibleId) { socket.send(JSON.stringify({ type: 'SUPPRESSION', idPostIt: noteCibleId })); menu.style.display = 'none'; }
        }

        function creerNote() {
            const id = "note-" + Date.now();
            const wx = (window.innerWidth/2 - panX)/zoom;
            const wy = (window.innerHeight/2 - panY)/zoom;
            sauver({ id: id, innerText: "Nouvelle note", style: { left: wx+"px", top: wy+"px", background: "#ffeaa7" } });
        }

        function rechercher(val) {
            document.querySelectorAll('.postit').forEach(n => {
                n.style.opacity = n.innerText.toLowerCase().includes(val.toLowerCase()) ? "1" : "0.1";
            });
        }

        socket.onmessage = (event) => {
            const data = JSON.parse(event.data);
            if (data.type === 'CURSEUR') {
                let c = document.getElementById('cur-' + data.auteur);
                if (!c) {
                    c = document.createElement('div'); c.id = 'cur-' + data.auteur; c.className = 'curseur';
                    c.style.background = `hsl(${data.auteur * 13.7}, 70%, 50%)`;
                    c.innerHTML = `<div class="curseur-label">${data.auteur}</div>`; plateau.appendChild(c);
                }
                c.style.left = data.x + 'px'; c.style.top = data.y + 'px';
            } else if (data.type === 'SUPPRESSION') {
                const el = document.getElementById(data.idPostIt); if (el) el.remove(); updateMinimap();
            } else if (data.type === 'MAJ') {
                let el = document.getElementById(data.idPostIt);
                if (!el) {
                    el = document.createElement('div'); el.id = data.idPostIt; el.className = 'postit';
                    el.contentEditable = true; el.addEventListener('input', () => sauver(el));
                    plateau.appendChild(el);
                }
                el.style.left = data.posX + 'px'; el.style.top = data.posY + 'px';
                el.style.background = data.couleur;
                if (data.auteur !== userId) el.innerText = data.texte;
                updateMinimap();
            }
        };
    </script>
</body>
</html>