<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Tableau Collaboratif - Menu LatÃ©ral</title>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background: #2c3e50; margin: 0; overflow: hidden; }
        #viewport { width: 100vw; height: 100vh; position: relative; overflow: hidden; cursor: grab; }
        #plateau { 
            width: 10000px; height: 10000px; background-color: #dfe6e9;
            background-image: radial-gradient(#bdc3c7 1px, transparent 1px);
            background-size: 40px 40px; position: absolute; transform-origin: 0 0;
        }
        
        #liens-svg { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 5; }
        
        .lien-trace { pointer-events: stroke; cursor: pointer; transition: stroke 0.2s; }
        .lien-trace:hover { stroke: #e74c3c !important; stroke-width: 4; }

        .postit { 
            width: 220px; min-height: 220px; position: absolute; padding: 20px; 
            box-shadow: 5px 5px 15px rgba(0,0,0,0.15); cursor: text; outline: none; 
            font-size: 16px; white-space: pre-wrap; word-break: break-all;
            display: flex; align-items: center; justify-content: center; text-align: center;
            box-sizing: border-box; z-index: 10;
        }
        .postit.selection-source { border: 4px solid #3498db !important; box-shadow: 0 0 20px #3498db; }
        .mode-lien-actif .postit { cursor: pointer !important; }

        .image-note { position: absolute; z-index: 10; cursor: move; border: 4px solid white; box-shadow: 0 5px 15px rgba(0,0,0,0.2); }
        .image-note img { max-width: 300px; display: block; pointer-events: none; }

        /* MENU LATÃ‰RAL AVEC OPTION CACHER */
        #sidebar { 
            position: fixed; left: 0; top: 0; bottom: 0; width: 250px; 
            background: #34495e; color: white; z-index: 3000; padding: 20px;
            box-shadow: 5px 0 15px rgba(0,0,0,0.3); display: flex; flex-direction: column; gap: 20px;
            transition: transform 0.3s ease; /* Animation de glissement */
        }
        
        /* Classe pour cacher la sidebar */
        #sidebar.hidden { transform: translateX(-250px); }

        /* BOUTON POUR CACHER/MONTRER */
        #toggle-sidebar {
            position: absolute; right: -40px; top: 20px; width: 40px; height: 40px;
            background: #34495e; color: white; border: none; cursor: pointer;
            border-radius: 0 8px 8px 0; font-size: 20px; box-shadow: 3px 0 10px rgba(0,0,0,0.2);
        }

        .sidebar-section { border-bottom: 1px solid #5d6d7e; padding-bottom: 15px; }
        .sidebar-section h3 { font-size: 14px; text-transform: uppercase; color: #bdc3c7; margin-bottom: 10px; }
        
        .btn-list { display: flex; flex-direction: column; gap: 10px; }
        .btn { 
            padding: 12px; cursor: pointer; background: #2ecc71; color: white; border: none; 
            border-radius: 6px; font-weight: bold; text-align: left; transition: 0.2s;
        }
        .btn:hover { opacity: 0.9; transform: translateX(5px); }
        .btn-blue { background: #3498db; }
        .btn-purple { background: #9b59b6; }
        .btn-orange { background: #e67e22; }
        .btn-active { background: #fff !important; color: #e67e22 !important; box-shadow: 0 0 10px rgba(255,255,255,0.5); }

        .search-bar { 
            width: 100%; padding: 10px; border-radius: 4px; border: none; 
            background: #2c3e50; color: white; box-sizing: border-box;
        }

        #minimap { 
            position: fixed; bottom: 20px; right: 20px; width: 180px; height: 180px; 
            background: rgba(255,255,255,0.95); border: 2px solid #34495e; 
            z-index: 3000; border-radius: 8px; overflow: hidden;
            transition: all 0.3s ease; box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }
        #minimap:hover { width: 450px; height: 450px; }
        #minimap-svg { width: 100%; height: 100%; }

        .curseur { position: absolute; width: 15px; height: 15px; border-radius: 50% 50% 50% 0; pointer-events: none; z-index: 1000; border: 2px solid white; transform: rotate(-45deg); }
        .curseur-label { position: absolute; left: 18px; top: 18px; background: inherit; color: white; padding: 2px 6px; border-radius: 4px; font-size: 10px; transform: rotate(45deg); white-space: nowrap; }

        #menu-context { position: fixed; display: none; background: white; border-radius: 8px; z-index: 4000; box-shadow: 0 10px 25px rgba(0,0,0,0.3); padding: 12px; width: 160px; }
        .color-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; margin-bottom: 10px; }
        .pastille { width: 30px; height: 30px; cursor: pointer; border-radius: 4px; border: 1px solid #ddd; }
        .btn-delete { width: 100%; padding: 8px; background: #e74c3c; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; }
        
        #infos { position: fixed; top: 15px; right: 15px; background: white; padding: 5px 10px; border-radius: 4px; font-size: 12px; z-index: 2000; }
    </style>
</head>
<body ondragover="event.preventDefault()" ondrop="dropImage(event)">

    <div id="sidebar">
        <button id="toggle-sidebar" onclick="toggleSidebar()">â˜°</button>

        <h2 style="margin:0; font-size: 20px;">ðŸ“Œ Post-it Board</h2>
        
        <div class="sidebar-section">
            <h3>Actions</h3>
            <div class="btn-list">
                <button class="btn" onclick="creerNote()">+ CrÃ©er une Note</button>
                <button id="btn-lien" class="btn btn-orange" onclick="toggleModeLien()">ðŸ”— Relier des Notes</button>
            </div>
        </div>

        <div class="sidebar-section">
            <h3>Vue</h3>
            <div class="btn-list">
                <button class="btn btn-blue" onclick="resetVue()">Recentrer la Vue</button>
                <button class="btn btn-purple" onclick="toggleZen()">Cacher les Curseurs</button>
            </div>
        </div>

        <div class="sidebar-section">
            <h3>Recherche</h3>
            <input type="text" class="search-bar" placeholder="Mot-clÃ©..." oninput="rechercher(this.value)">
        </div>

        <div style="margin-top:auto; font-size: 11px; color: #7f8c8d;">
            Clic droit sur un Post-it : Couleur / Supprimer<br>
            Clic droit sur un Lien : Supprimer le lien
        </div>
    </div>

    <div id="infos">Utilisateur: <b id="my-id">..</b> | Zoom: <b id="zoom-val">100%</b></div>
    <div id="minimap"><svg id="minimap-svg" viewBox="0 0 10000 10000"></svg></div>

    <div id="menu-context">
        <div class="color-grid" id="palette"></div>
        <button class="btn-delete" onclick="supprimerNoteCible()">SUPPRIMER</button>
    </div>

    <div id="viewport">
        <div id="plateau"><svg id="liens-svg"></svg></div>
    </div>

    <script>
        // FONCTION AJOUTÃ‰E POUR LE BOUTON
        function toggleSidebar() {
            document.getElementById('sidebar').classList.toggle('hidden');
        }

        const userId = Math.floor(Math.random() * 90 + 10);
        document.getElementById('my-id').innerText = userId;
        const socket = new WebSocket('ws://localhost:3000');
        const plateau = document.getElementById('plateau');
        const svgLayer = document.getElementById('liens-svg');
        const miniSvg = document.getElementById('minimap-svg');
        const menu = document.getElementById('menu-context');
        
        let zoom = 1, panX = -4500, panY = -4500, isPanning = false, noteCibleId = null;
        let modeLien = false, sourceLienId = null;

        const couleurs = ['#ffeaa7', '#fab1a0', '#81ecec', '#55efc4', '#a29bfe', '#fd79a8', '#74b9ff', '#ffffff', '#dfe6e9', '#ffe2e2', '#e2f0cb', '#badc58'];

        const grid = document.getElementById('palette');
        couleurs.forEach(c => {
            const p = document.createElement('div'); p.className = 'pastille'; p.style.background = c;
            p.onclick = () => { const el = document.getElementById(noteCibleId); if(el){el.style.background = c; sauver(el);} menu.style.display = 'none'; };
            grid.appendChild(p);
        });

        function refresh() { 
            plateau.style.transform = `translate(${panX}px, ${panY}px) scale(${zoom})`; 
            document.getElementById('zoom-val').innerText = Math.round(zoom * 100) + "%";
            updateMinimap(); tracerLiens();
        }

        function resetVue() { zoom = 1; panX = (window.innerWidth/2)-4850; panY = (window.innerHeight/2)-5000; refresh(); }
        function toggleZen() { document.body.classList.toggle('zen-mode'); }

        function toggleModeLien() {
            modeLien = !modeLien; sourceLienId = null;
            document.body.classList.toggle('mode-lien-actif', modeLien);
            document.getElementById('btn-lien').classList.toggle('btn-active', modeLien);
            document.querySelectorAll('.postit').forEach(p => p.classList.remove('selection-source'));
        }

        function updateMinimap() {
            miniSvg.innerHTML = '';
            document.querySelectorAll('[data-type="LIEN"]').forEach(l => {
                const n1 = document.getElementById(l.dataset.from), n2 = document.getElementById(l.dataset.to);
                if(n1 && n2) {
                    const line = document.createElementNS("http://www.w3.org/2000/svg", "line");
                    line.setAttribute("x1", parseFloat(n1.style.left)+110); line.setAttribute("y1", parseFloat(n1.style.top)+110);
                    line.setAttribute("x2", parseFloat(n2.style.left)+110); line.setAttribute("y2", parseFloat(n2.style.top)+110);
                    line.setAttribute("stroke", "#95a5a6"); line.setAttribute("stroke-width", "50");
                    miniSvg.appendChild(line);
                }
            });
            document.querySelectorAll('.postit, .image-note').forEach(n => {
                const rect = document.createElementNS("http://www.w3.org/2000/svg", "rect");
                rect.setAttribute("x", parseFloat(n.style.left)); rect.setAttribute("y", parseFloat(n.style.top));
                rect.setAttribute("width", "250"); rect.setAttribute("height", "250");
                rect.setAttribute("fill", n.style.background || "#ffffff");
                miniSvg.appendChild(rect);
            });
        }

        function tracerLiens() {
            svgLayer.innerHTML = '';
            document.querySelectorAll('[data-type="LIEN"]').forEach(l => {
                const n1 = document.getElementById(l.dataset.from), n2 = document.getElementById(l.dataset.to);
                if(n1 && n2) {
                    const line = document.createElementNS("http://www.w3.org/2000/svg", "line");
                    line.className.baseVal = "lien-trace";
                    line.setAttribute("x1", parseFloat(n1.style.left)+110); line.setAttribute("y1", parseFloat(n1.style.top)+110);
                    line.setAttribute("x2", parseFloat(n2.style.left)+110); line.setAttribute("y2", parseFloat(n2.style.top)+110);
                    line.setAttribute("stroke", "#95a5a6"); line.setAttribute("stroke-width", "3");
                    line.oncontextmenu = (e) => { e.preventDefault(); socket.send(JSON.stringify({ type: 'SUPPRESSION', idPostIt: l.id })); };
                    svgLayer.appendChild(line);
                }
            });
        }

        function sauver(el) {
            socket.send(JSON.stringify({
                type: 'MAJ', idPostIt: el.id, auteur: userId,
                posX: parseFloat(el.style.left), posY: parseFloat(el.style.top),
                texte: el.innerText, couleur: el.style.background
            }));
        }

        window.addEventListener('wheel', (e) => {
            if(e.target.closest('#minimap') || e.target.closest('#sidebar')) return;
            e.preventDefault();
            const delta = e.deltaY > 0 ? 0.9 : 1.1;
            panX = e.clientX - (e.clientX - panX) * delta; panY = e.clientY - (e.clientY - panY) * delta;
            zoom *= delta; refresh();
        }, { passive: false });

        window.addEventListener('mousedown', (e) => {
            if (!menu.contains(e.target)) menu.style.display = 'none';
            if (e.button === 0 && (e.target.id === 'plateau' || e.target.id === 'viewport')) isPanning = true;
        });

        window.addEventListener('mousemove', (e) => {
            if (isPanning) { panX += e.movementX; panY += e.movementY; refresh(); }
            const wx = (e.clientX - panX) / zoom; const wy = (e.clientY - panY) / zoom;
            if (socket.readyState === 1) socket.send(JSON.stringify({ type: 'CURSEUR', auteur: userId, x: wx, y: wy }));
        });

        window.addEventListener('mouseup', () => isPanning = false);

        document.addEventListener('mousedown', (e) => {
            const target = e.target.closest('.postit, .image-note');
            if (target && e.button === 0) {
                if(modeLien && target.classList.contains('postit')) {
                    if(!sourceLienId) {
                        sourceLienId = target.id; target.classList.add('selection-source');
                    } else if(sourceLienId !== target.id) {
                        socket.send(JSON.stringify({ type: 'LIEN', idLien: "L-"+Date.now(), from: sourceLienId, to: target.id }));
                        toggleModeLien();
                    }
                    return;
                }
                const el = target;
                const startX = e.clientX, startY = e.clientY, initL = parseFloat(el.style.left), initT = parseFloat(el.style.top);
                const move = (m) => {
                    el.style.left = (initL + (m.clientX - startX) / zoom) + 'px';
                    el.style.top = (initT + (m.clientY - startY) / zoom) + 'px';
                    sauver(el); updateMinimap(); tracerLiens();
                };
                const up = () => { window.removeEventListener('mousemove', move); window.removeEventListener('mouseup', up); };
                window.addEventListener('mousemove', move); window.addEventListener('mouseup', up);
            }
        });

        window.addEventListener('contextmenu', (e) => {
            const n = e.target.closest('.postit, .image-note');
            if (n) { e.preventDefault(); noteCibleId = n.id; menu.style.display = 'block'; menu.style.top = e.clientY + 'px'; menu.style.left = e.clientX + 'px'; }
        });

        function supprimerNoteCible() { if (noteCibleId) { socket.send(JSON.stringify({ type: 'SUPPRESSION', idPostIt: noteCibleId })); menu.style.display = 'none'; } }
        function creerNote() {
            socket.send(JSON.stringify({ type: 'MAJ', idPostIt: "note-"+Date.now(), auteur: userId, posX: (window.innerWidth/2 - panX + 125)/zoom, posY: (window.innerHeight/2 - panY)/zoom, texte: "Nouvelle note", couleur: "#ffeaa7" }));
        }

        function dropImage(e) {
            e.preventDefault();
            const file = e.dataTransfer.files[0];
            if (file && file.type.startsWith('image/')) {
                const reader = new FileReader();
                reader.onload = (event) => {
                    socket.send(JSON.stringify({ type: 'IMAGE', idPostIt: "img-"+Date.now(), src: event.target.result, posX: (e.clientX - panX)/zoom, posY: (e.clientY - panY)/zoom }));
                };
                reader.readAsDataURL(file);
            }
        }

        function rechercher(val) {
            document.querySelectorAll('.postit').forEach(n => { n.style.opacity = n.innerText.toLowerCase().includes(val.toLowerCase()) ? "1" : "0.1"; });
        }

        socket.onmessage = (event) => {
            const data = JSON.parse(event.data);
            if (data.type === 'CURSEUR') {
                let c = document.getElementById('cur-' + data.auteur);
                if (!c) {
                    c = document.createElement('div'); c.id = 'cur-' + data.auteur; c.className = 'curseur';
                    c.style.background = `hsl(${data.auteur * 13.7}, 70%, 50%)`;
                    c.innerHTML = `<div class="curseur-label">${data.auteur}</div>`; plateau.appendChild(c);
                }
                c.style.left = data.x + 'px'; c.style.top = data.y + 'px';
            } else if (data.type === 'SUPPRESSION') {
                document.getElementById(data.idPostIt || data.idLien)?.remove();
                updateMinimap(); tracerLiens();
            } else if (data.type === 'MAJ') {
                let el = document.getElementById(data.idPostIt);
                if (!el) {
                    el = document.createElement('div'); el.id = data.idPostIt; el.className = 'postit';
                    el.contentEditable = true; el.addEventListener('input', () => sauver(el));
                    plateau.appendChild(el);
                }
                el.style.left = data.posX + 'px'; el.style.top = data.posY + 'px';
                el.style.background = data.couleur;
                if (data.auteur !== userId) el.innerText = data.texte;
                updateMinimap(); tracerLiens();
            } else if (data.type === 'IMAGE') {
                let el = document.getElementById(data.idPostIt);
                if (!el) {
                    el = document.createElement('div'); el.id = data.idPostIt; el.className = 'image-note';
                    el.innerHTML = `<img src="${data.src}">`; plateau.appendChild(el);
                }
                el.style.left = data.posX + 'px'; el.style.top = data.posY + 'px';
                updateMinimap();
            } else if (data.type === 'LIEN') {
                if(!document.getElementById(data.idLien)) {
                    const l = document.createElement('div'); l.id = data.idLien;
                    l.dataset.type = "LIEN"; l.dataset.from = data.from; l.dataset.to = data.to;
                    document.body.appendChild(l); updateMinimap(); tracerLiens();
                }
            }
        };
        resetVue();
    </script>
</body>
</html>