<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Tableau Collaboratif</title>
    <style>
        body { font-family: sans-serif; background: #dfe6e9; margin: 0; overflow: hidden; }
        #plateau { width: 100vw; height: 100vh; position: relative; }
        .postit { 
            width: 150px; height: 150px; background: #ffeaa7; 
            position: absolute; padding: 15px; box-shadow: 3px 3px 10px rgba(0,0,0,0.1);
            cursor: grab; border: 1px solid #fab1a0; overflow: hidden;
            outline: none; font-size: 14px; word-wrap: break-word;
        }
        .postit:active { cursor: grabbing; }
        #infos { position: fixed; top: 10px; right: 10px; background: white; padding: 10px; border-radius: 5px; z-index: 10; border: 1px solid #ccc; }
        .btn-add { position: fixed; top: 10px; left: 10px; padding: 10px 20px; z-index: 10; cursor: pointer; background: #2ecc71; color: white; border: none; border-radius: 4px; font-weight: bold; }
    </style>
</head>
<body>

    <button class="btn-add" onclick="creerNote()">+ Ajouter une note</button>
    <div id="infos">Mon ID Utilisateur : <b id="user-id-label">..</b></div>
    
    <div id="plateau"></div>

    <script>
        // Generation de l'ID utilisateur entre 10 et 99
        const userId = Math.floor(Math.random() * (99 - 10) + 10);
        document.getElementById('user-id-label').innerText = userId;

        const socket = new WebSocket('ws://localhost:3000');
        const plateau = document.getElementById('plateau');

        socket.onmessage = (event) => {
            const data = JSON.parse(event.data);

            // Gestion de la suppression visuelle
            if (data.type === 'SUPPRESSION') {
                const el = document.getElementById(data.idPostIt);
                if (el) el.remove();
                return;
            }

            // Gestion creation ou mise a jour
            let el = document.getElementById(data.idPostIt);
            if (!el) {
                el = document.createElement('div');
                el.id = data.idPostIt;
                el.className = 'postit';
                el.contentEditable = true;
                el.innerText = data.texte;
                plateau.appendChild(el);
            }

            el.style.left = data.posX + 'px';
            el.style.top = data.posY + 'px';

            // Mise a jour du texte si l'auteur est different
            if (data.auteur !== userId && el.innerText !== data.texte) {
                el.innerText = data.texte;
            }
        };

        function creerNote() {
            const idUniqueNote = "note-" + Date.now() + "-" + userId;
            envoyer(idUniqueNote, 100, 100, "Nouvelle note...");
        }

        function envoyer(idNote, x, y, txt, type = 'MAJ') {
            const message = {
                type: type,
                idPostIt: idNote,
                auteur: userId,
                posX: x,
                posY: y,
                texte: txt
            };
            if (socket.readyState === WebSocket.OPEN) {
                socket.send(JSON.stringify(message));
            }
        }

        // Deplacement des notes
        document.addEventListener('mousedown', (e) => {
            if (e.target.classList.contains('postit')) {
                const el = e.target;
                const decalageX = e.clientX - el.offsetLeft;
                const decalageY = e.clientY - el.offsetTop;

                const glisser = (m) => {
                    const x = m.clientX - decalageX;
                    const y = m.clientY - decalageY;
                    el.style.left = x + 'px';
                    el.style.top = y + 'px';
                    envoyer(el.id, x, y, el.innerText);
                };

                document.onmousemove = glisser;
                document.onmouseup = () => { document.onmousemove = null; };
            }
        });

        // Modification du texte
        document.addEventListener('input', (e) => {
            if (e.target.classList.contains('postit')) {
                const el = e.target;
                envoyer(el.id, parseInt(el.style.left), parseInt(el.style.top), el.innerText);
            }
        });

        // Suppression par clic droit avec confirmation
        document.addEventListener('contextmenu', (e) => {
            if (e.target.classList.contains('postit')) {
                e.preventDefault();
                if (confirm("Voulez-vous vraiment supprimer cette note ?")) {
                    envoyer(e.target.id, 0, 0, "", 'SUPPRESSION');
                }
            }
        });
    </script>
</body>
</html>